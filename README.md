# Tutorial: Dynamic Causal Modelling (DCM) of M/EEG
Demo scripts for Dynamic Causal Modelling (DCM) of M/EEG data from the Wakeman & Henson (2015) open dataset using a hierarchical Bayesian framework called Parametric Empirical Bayes (PEB). 

## Software
- Clone this repository on your system. 
- The tutorial uses the current stable version of SPM12 with minor patches available here: https://github.com/pranaysy/spm12  Please set this as the primary SPM version on your MATLAB path for use with this tutorial.

### Overview of scripts
- ```./code/spm_master_script_dcm_peb_batch.m``` performs specification & estimation of DCMs and inference with PEB using SPM's scripted batch interface. This is close to the batch GUI functionality.
- ```./code/spm_master_script_dcm_peb_batch_patched.m``` does the same thing as the script above, but relies more on the patched SPM codeabase for identical replication of batch GUI functionality.
- ```./code/spm_master_script_dcm_peb_script.m``` performs specification & estimation of DCMs and inference with PEB using scripted direct calls to relevant SPM functions. This is more versatile and streamlined, but needs experience with scripting.
- ```./code/spm_master_script_data_preprocessing.m``` processes raw data from Wakeman & Henson (2015) as per Henson et al (2019) and produces tutorial-ready data with forward models. Can take a long while to run if running locally.
- ```./code/batch*job.m``` files are jobfiles generated by SPM's batch interface and are called by scripts above for various pipelined routines.

## Dataset
The raw BIDS-formatted dataset can be obtained from [OpenNeuro](https://openneuro.org/datasets/ds000117/versions/1.0.5) using tools like [datalad](https://www.datalad.org/) or [git-annex.](https://git-annex.branchable.com/) Processing of the raw data is done according to Henson et al (2019), and a [convenience script is provided](https://github.com/pranaysy/DCM-MEEG-Demo/blob/094c28fa49dbaa21fc1b41451e74cd6326c7c30f/code/spm_master_script_data_preprocessing.m) for processing data in preparation for this tutorial. The script differs from the one in Henson et al (2019) in three ways:
  1. Baseline correction is done during epoching in this tutorial, but is skipped in the paper.
  2. Robust averaging is done per condition in this tutorial, whereas a simple average is taken in the paper.
  3. The script for this tutorial stops at forward modelling, with an additional line of code to force-write the estimated leadfield to a file, whereas the leadfield is estimated only during inversion in the paper.
  
The pre-processing steps can be skipped entirely and tutorial-ready data with forward models for all 16 subjects can be downloaded [from figshare here.](https://figshare.com/articles/dataset/Face_processing_M_EEG_data_for_Dynamic_Causal_Modelling/21130297)

Once processed, the data should be stored as indicated in [./data/folder_structure.txt](https://github.com/pranaysy/DCM-MEEG-Demo/blob/094c28fa49dbaa21fc1b41451e74cd6326c7c30f/data/folder_structure.txt)

### References
1. Wakeman, D.G. & Henson, R.N. (2015). A multi-subject, multi-modal human neuroimaging dataset. Sci. Data 2:150001 doi: 10.1038/sdata.2015.1
2. Henson RN, Abdulrahman H, Flandin G and Litvak V (2019) Multimodal Integration of M/EEG and f/MRI Data in SPM12. Front. Neurosci. 13:300. doi: 10.3389/fnins.2019.00300
3. Yadav, Pranay; Henson, Rik (2022): Face processing M/EEG data for Dynamic Causal Modelling. figshare. Dataset. https://doi.org/10.6084/m9.figshare.21130297.v1 
